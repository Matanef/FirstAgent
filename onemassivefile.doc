Client:

App.jsx:
/**
 * Enhanced React Chat UI
 * Features:
 * - Multiple conversations with preview
 * - Loading states
 * - Error handling
 * - Confidence indicators
 * - Tool usage display
 * - Markdown support
 */

import { useState, useEffect, useRef } from "react";
import "./App.css";

const API_URL = "http://localhost:3000";

function App() {
  const [conversations, setConversations] = useState({});
  const [activeId, setActiveId] = useState(null);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [metadata, setMetadata] = useState(null);

  const messagesEndRef = useRef(null);

  // Auto-scroll to bottom
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [conversations, activeId]);

  // Create new conversation
  function newChat() {
    const id = crypto.randomUUID();
    setConversations(c => ({ ...c, [id]: [] }));
    setActiveId(id);
    setError(null);
    setMetadata(null);
  }

  // Delete conversation
  function deleteChat(id, e) {
    e.stopPropagation();
    
    if (!confirm("Delete this conversation?")) return;

    const newConvos = { ...conversations };
    delete newConvos[id];
    setConversations(newConvos);

    if (activeId === id) {
      setActiveId(null);
    }
  }

  // Send message
  async function sendMessage() {
    if (!input.trim() || !activeId || loading) return;

    const userMsg = {
      role: "user",
      content: input,
      timestamp: new Date().toISOString()
    };

    // Update UI immediately
    setConversations(c => ({
      ...c,
      [activeId]: [...c[activeId], userMsg]
    }));

    setInput("");
    setLoading(true);
    setError(null);

    try {
      const res = await fetch(`${API_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: userMsg.content,
          conversationId: activeId
        })
      });

      if (!res.ok) {
        throw new Error(`Server error: ${res.status}`);
      }

      const data = await res.json();

      const botMsg = {
        role: "assistant",
        content: data.reply,
        timestamp: new Date().toISOString(),
        confidence: data.confidence,
        stateGraph: data.stateGraph
      };

      setConversations(c => ({
        ...c,
        [activeId]: [...c[activeId], botMsg]
      }));

      setMetadata(data.metadata);

    } catch (err) {
      console.error("Send error:", err);
      setError(err.message);

      // Add error message to chat
      const errorMsg = {
        role: "error",
        content: `Error: ${err.message}`,
        timestamp: new Date().toISOString()
      };

      setConversations(c => ({
        ...c,
        [activeId]: [...c[activeId], errorMsg]
      }));

    } finally {
      setLoading(false);
    }
  }

  // Handle Enter key
  function handleKeyDown(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  const messages = activeId ? conversations[activeId] : [];

  return (
    <div className="app-container">
      {/* Sidebar */}
      <div className="sidebar">
        <div className="sidebar-header">
          <h2>ğŸ’¬ Chats</h2>
          <button onClick={newChat} className="new-chat-btn" title="New Chat">
            â•
          </button>
        </div>

        <div className="conversation-list">
          {Object.keys(conversations).length === 0 ? (
            <div className="empty-state">No conversations yet</div>
          ) : (
            Object.keys(conversations).map(id => {
              const convo = conversations[id];
              const preview = convo[0]?.content || "Empty chat";

              return (
                <div
                  key={id}
                  onClick={() => setActiveId(id)}
                  className={`conversation-item ${id === activeId ? 'active' : ''}`}
                >
                  <div className="conversation-preview">
                    {preview.slice(0, 40)}
                    {preview.length > 40 ? "..." : ""}
                  </div>
                  <div className="conversation-meta">
                    <span className="message-count">{convo.length} msgs</span>
                    <button
                      onClick={(e) => deleteChat(id, e)}
                      className="delete-btn"
                      title="Delete"
                    >
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      {/* Chat area */}
      <div className="chat-container">
        <div className="chat-header">
          <h1>ğŸ¤– AI Agent</h1>
          {metadata && (
            <div className="metadata">
              <span title="Execution time">â±ï¸ {metadata.executionTime}ms</span>
              <span title="Tools used">ğŸ”§ {metadata.toolsUsed.join(", ") || "none"}</span>
              <span title="Steps taken">ğŸ“Š {metadata.steps} steps</span>
            </div>
          )}
        </div>

        {!activeId ? (
          <div className="welcome-screen">
            <h2>Welcome to AI Agent</h2>
            <p>Start a new conversation to begin</p>
            <button onClick={newChat} className="start-chat-btn">
              Start New Chat
            </button>
            <div className="capabilities">
              <h3>I can help with:</h3>
              <ul>
                <li>ğŸ“ˆ <strong>Stock market data</strong> - Top stocks by sector (e.g., "top 10 bioengineering stocks")</li>
                <li>ğŸ” <strong>Web search</strong> - Find information on any topic</li>
                <li>ğŸ§® <strong>Calculations</strong> - Solve math expressions</li>
                <li>ğŸ’¬ <strong>General chat</strong> - Answer questions and have conversations</li>
              </ul>
            </div>
          </div>
        ) : (
          <>
            <div className="messages-container">
              {messages.length === 0 ? (
                <div className="empty-chat">
                  <p>Send a message to start the conversation</p>
                </div>
              ) : (
                messages.map((m, i) => (
                  <div key={i} className={`message ${m.role}`}>
                    <div className="message-header">
                      <span className="role-badge">
                        {m.role === "user" ? "ğŸ‘¤" : m.role === "error" ? "âš ï¸" : "ğŸ¤–"}
                        {m.role}
                      </span>
                      {m.confidence !== undefined && (
                        <span className="confidence" title="Response confidence">
                          {(m.confidence * 100).toFixed(0)}% confident
                        </span>
                      )}
                    </div>
                    <div className="message-content">
                      {m.content}
                    </div>
                    {m.stateGraph && m.stateGraph.length > 0 && (
                      <details className="state-graph">
                        <summary>ğŸ” View execution trace ({m.stateGraph.length} steps)</summary>
                        <pre>{JSON.stringify(m.stateGraph, null, 2)}</pre>
                      </details>
                    )}
                  </div>
                ))
              )}

              {loading && (
                <div className="message assistant loading">
                  <div className="message-header">
                    <span className="role-badge">ğŸ¤– assistant</span>
                  </div>
                  <div className="message-content">
                    <div className="typing-indicator">
                      <span></span>
                      <span></span>
                      <span></span>
                    </div>
                  </div>
                </div>
              )}

              <div ref={messagesEndRef} />
            </div>

            <div className="input-container">
              {error && (
                <div className="error-banner">
                  âš ï¸ {error}
                </div>
              )}

              <div className="input-wrapper">
                <textarea
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder="Type your message... (Enter to send, Shift+Enter for new line)"
                  disabled={loading}
                  rows={1}
                  className="message-input"
                />
                <button
                  onClick={sendMessage}
                  disabled={loading || !input.trim()}
                  className="send-btn"
                  title="Send message"
                >
                  {loading ? "â³" : "ğŸ“¤"}
                </button>
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

export default App;


App.css:
/* Enhanced App Styling */

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg-primary: #0f1419;
  --bg-secondary: #192734;
  --bg-tertiary: #22303c;
  --bg-hover: #273948;
  
  --text-primary: #e7e9ea;
  --text-secondary: #8b98a5;
  --text-muted: #6e7d8a;
  
  --accent: #1d9bf0;
  --accent-hover: #1a8cd8;
  
  --success: #00ba7c;
  --error: #f4212e;
  --warning: #ffd400;
  
  --border: #38444d;
  --shadow: rgba(0, 0, 0, 0.5);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.5;
}

.app-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* ========== SIDEBAR ========== */

.sidebar {
  width: 280px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: transform 0.3s ease;
}

.sidebar-header {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sidebar-header h2 {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
}

.new-chat-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 1rem;
}

.new-chat-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.05);
}

.conversation-list {
  flex: 1;
  overflow-y: auto;
  padding: 0.5rem;
}

.conversation-item {
  padding: 0.75rem;
  margin-bottom: 0.25rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  border: 1px solid transparent;
}

.conversation-item:hover {
  background: var(--bg-hover);
}

.conversation-item.active {
  background: var(--bg-tertiary);
  border-color: var(--accent);
}

.conversation-preview {
  color: var(--text-primary);
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.conversation-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.message-count {
  color: var(--text-secondary);
}

.delete-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  opacity: 0.6;
  transition: opacity 0.2s;
}

.delete-btn:hover {
  opacity: 1;
}

.empty-state {
  padding: 2rem 1rem;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* ========== CHAT CONTAINER ========== */

.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
}

.chat-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-secondary);
}

.chat-header h1 {
  font-size: 1.5rem;
  font-weight: 600;
}

.metadata {
  display: flex;
  gap: 1rem;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.metadata span {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

/* ========== WELCOME SCREEN ========== */

.welcome-screen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  text-align: center;
}

.welcome-screen h2 {
  font-size: 2rem;
  margin-bottom: 1rem;
  background: linear-gradient(135deg, var(--accent), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.welcome-screen p {
  color: var(--text-secondary);
  margin-bottom: 2rem;
  font-size: 1.1rem;
}

.start-chat-btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 0.875rem 2rem;
  border-radius: 24px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.start-chat-btn:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(29, 155, 240, 0.3);
}

.capabilities {
  margin-top: 3rem;
  max-width: 600px;
  text-align: left;
}

.capabilities h3 {
  margin-bottom: 1rem;
  color: var(--text-primary);
}

.capabilities ul {
  list-style: none;
  padding: 0;
}

.capabilities li {
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  background: var(--bg-secondary);
  border-radius: 8px;
  border-left: 3px solid var(--accent);
  color: var(--text-secondary);
}

.capabilities strong {
  color: var(--text-primary);
}

/* ========== MESSAGES ========== */

.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.empty-chat {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
}

.message {
  max-width: 80%;
  padding: 1rem;
  border-radius: 12px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.user {
  align-self: flex-end;
  background: var(--accent);
  color: white;
  margin-left: auto;
}

.message.assistant {
  align-self: flex-start;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
}

.message.error {
  align-self: flex-start;
  background: rgba(244, 33, 46, 0.1);
  border: 1px solid var(--error);
  color: var(--error);
}

.message.loading {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
}

.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  font-size: 0.85rem;
}

.role-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  text-transform: capitalize;
}

.confidence {
  background: rgba(0, 186, 124, 0.2);
  color: var(--success);
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
}

.message-content {
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.6;
}

.message.user .message-content {
  color: white;
}

/* ========== TYPING INDICATOR ========== */

.typing-indicator {
  display: flex;
  gap: 0.4rem;
  padding: 0.5rem 0;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: bounce 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes bounce {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.4;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

/* ========== STATE GRAPH ========== */

.state-graph {
  margin-top: 0.75rem;
  font-size: 0.85rem;
}

.state-graph summary {
  cursor: pointer;
  color: var(--text-secondary);
  user-select: none;
  padding: 0.5rem;
  background: var(--bg-tertiary);
  border-radius: 6px;
}

.state-graph summary:hover {
  color: var(--text-primary);
  background: var(--bg-hover);
}

.state-graph pre {
  margin-top: 0.5rem;
  padding: 1rem;
  background: var(--bg-primary);
  border-radius: 6px;
  border: 1px solid var(--border);
  overflow-x: auto;
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* ========== INPUT ========== */

.input-container {
  padding: 1rem 1.5rem;
  background: var(--bg-secondary);
  border-top: 1px solid var(--border);
}

.error-banner {
  background: rgba(244, 33, 46, 0.1);
  border: 1px solid var(--error);
  color: var(--error);
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
}

.input-wrapper {
  display: flex;
  gap: 0.75rem;
  align-items: flex-end;
}

.message-input {
  flex: 1;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.875rem 1rem;
  color: var(--text-primary);
  font-size: 1rem;
  font-family: inherit;
  resize: none;
  max-height: 150px;
  transition: border-color 0.2s;
}

.message-input:focus {
  outline: none;
  border-color: var(--accent);
}

.message-input:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.send-btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 0.875rem 1.5rem;
  border-radius: 12px;
  font-size: 1.25rem;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 60px;
}

.send-btn:hover:not(:disabled) {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

.send-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* ========== SCROLLBAR ========== */

::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-primary);
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}

/* ========== RESPONSIVE ========== */

@media (max-width: 768px) {
  .sidebar {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    z-index: 10;
    transform: translateX(-100%);
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .message {
    max-width: 90%;
  }

  .metadata {
    flex-direction: column;
    gap: 0.25rem;
    align-items: flex-end;
  }
}


Server:
index.js:
// server/index.js

import express from "express";
import cors from "cors";
import crypto from "crypto";
import { plan } from "./planner.js";
import { loadJSON, saveJSON } from "./memory.js";
import { executeAgent } from "./executor.js";
import { calculateConfidence } from "./audit.js";

const app = express();
const PORT = process.env.PORT || 3000;
const MEMORY_FILE = "./memory.json";

app.use(cors());
app.use(express.json({ limit: "1mb" }));

// ----------------------------------------
// Logging Middleware
// ----------------------------------------
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
  next();
});

// ----------------------------------------
// Health Check
// ----------------------------------------
app.get("/health", (req, res) => {
  res.json({
    status: "healthy",
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// ----------------------------------------
// Chat Endpoint
// ----------------------------------------
app.post("/chat", async (req, res) => {
  const startTime = Date.now();

  try {
    let { message, conversationId } = req.body;

    if (!message || typeof message !== "string") {
      return res.status(400).json({ error: "Missing or invalid message" });
    }

    if (message.length > 1000) {
      return res.status(400).json({
        error: "Message too long (max 1000 characters)"
      });
    }

    console.log("\n" + "=".repeat(60));
    console.log("ğŸ‘¤ USER:", message);

    // ----------------------------------------
    // Load Memory
    // ----------------------------------------
    const memory = loadJSON(MEMORY_FILE, { conversations: {} });
    const id = conversationId || crypto.randomUUID();

    memory.conversations[id] ??= [];
    const convo = memory.conversations[id];

    // Save user message
    convo.push({
      role: "user",
      content: message,
      timestamp: new Date().toISOString()
    });

    // ----------------------------------------
    // Preprocess message: detect file paths
    // ----------------------------------------
    function extractPath(text) {
      const match = text.match(/[A-Za-z]:[\\/]{1,2}[^?\s]+/);
      return match ? match[0] : null;
    }

    if (/scan\s+[A-Za-z]:[\\/]/i.test(message)) {
      const path = extractPath(message);
      if (path) {
        message = path;
        console.log("ğŸ›  Detected file scan path:", message);
      }
    }

    // ----------------------------------------
    // Execute Agent
    // ----------------------------------------
    // ----------------------------------------
// Plan â†’ Execute Agent
// ----------------------------------------
const { tool } = await plan({ message });

const result = await executeAgent({ tool, message });

    const reply = result.reply;
    const stateGraph = result.stateGraph;

    if (!reply) {
      throw new Error("Executor returned no reply");
    }

    // ----------------------------------------
    // Confidence Calculation
    // ----------------------------------------
    const confidence = calculateConfidence(stateGraph);

    // Save assistant reply
    convo.push({
      role: "assistant",
      content: reply,
      timestamp: new Date().toISOString(),
      confidence
    });

    saveJSON(MEMORY_FILE, memory);

    const elapsed = Date.now() - startTime;

    console.log("\nğŸ“Š SUMMARY");
    console.log("Steps:", stateGraph.length);
    console.log("Tool Used:", result.tool || "none");
    console.log("Confidence:", (confidence * 100).toFixed(1) + "%");
    console.log("Time:", elapsed + "ms");
    console.log("=".repeat(60) + "\n");

    // ----------------------------------------
    // Response
    // ----------------------------------------
    res.json({
      reply,
      stateGraph,
      tool: result.tool,
      data: result.data,
      success: result.success,
      confidence,
      conversationId: id,
      metadata: {
        steps: stateGraph.length,
        executionTime: elapsed
      }
    });

  } catch (err) {
    console.error("âŒ CHAT ERROR:", err);

    res.status(500).json({
      error: "Internal server error",
      message: err.message
    });
  }
});

// ----------------------------------------
// Conversation APIs
// ----------------------------------------
app.get("/conversation/:id", (req, res) => {
  const memory = loadJSON(MEMORY_FILE, { conversations: {} });
  const conversation = memory.conversations[req.params.id];

  if (!conversation) {
    return res.status(404).json({ error: "Conversation not found" });
  }

  res.json({
    conversationId: req.params.id,
    messages: conversation
  });
});

app.get("/conversations", (req, res) => {
  const memory = loadJSON(MEMORY_FILE, { conversations: {} });
  const conversations = Object.entries(memory.conversations).map(
    ([id, messages]) => ({
      id,
      messageCount: messages.length,
      lastMessage: messages[messages.length - 1]?.timestamp,
      preview: messages[0]?.content.slice(0, 50)
    })
  );
  res.json({ conversations });
});

app.delete("/conversation/:id", (req, res) => {
  const memory = loadJSON(MEMORY_FILE, { conversations: {} });
  if (!memory.conversations[req.params.id]) {
    return res.status(404).json({ error: "Conversation not found" });
  }
  delete memory.conversations[req.params.id];
  saveJSON(MEMORY_FILE, memory);
  res.json({ success: true });
});

// ----------------------------------------
// Start Server
// ----------------------------------------
app.listen(PORT, () => {
  console.log("\n" + "=".repeat(60));
  console.log("ğŸ¤– AI AGENT SERVER STARTED");
  console.log(`ğŸ“¡ http://localhost:${PORT}`);
  console.log("=".repeat(60) + "\n");
});

process.on("SIGINT", () => {
  console.log("\nğŸ‘‹ Shutting down...");
  process.exit(0);
});


audit,js:
export function detectContradictions(stateGraph, newOutput) {
  if (!newOutput) return [];

  const newStr =
    typeof newOutput === "string"
      ? newOutput
      : JSON.stringify(newOutput);

  const last = stateGraph[stateGraph.length - 1];

  if (!last) return [];

  const prevStr =
    typeof last.output === "string"
      ? last.output
      : JSON.stringify(last.output);

  if (prevStr === newStr) return [];

  if (prevStr && newStr && prevStr !== newStr) {
    return ["Potential contradiction detected"];
  }

  return [];
}

export function calculateConfidence(stateGraph) {
  let score = 0.5;

  const usedFinance = stateGraph.some(s => s.tool === "finance");
  const usedSearch = stateGraph.some(s => s.tool === "search");
  const contradictions = stateGraph.flatMap(s => s.contradictions || []);
  const citationMiss = stateGraph.flatMap(s => s.citationMiss || []);

  if (usedFinance) score += 0.25;
  if (usedSearch) score += 0.15;
  if (contradictions.length > 0) score -= 0.2;
  if (citationMiss.length > 0) score -= 0.2;

  return Math.min(Math.max(score, 0.1), 0.95);
}



executor.js:
// server/executor.js

import { TOOLS } from "./tools/index.js";

/**
 * Use LLM to summarize tool output
 */
async function summarizeWithLLM(userQuestion, toolResult) {
  const structuredData = JSON.stringify(toolResult.data, null, 2);

  const prompt = `
User question:
${userQuestion}

Tool returned this structured data:
${structuredData}

Provide a clear, direct answer to the user.
Do NOT list search results.
Do NOT include URLs.
Answer naturally and concisely.
`;

  const summary = await TOOLS.llm.execute(prompt);

  return summary?.data?.text || "Unable to summarize result.";
}

/**
 * Execute planned tool
 */
export async function executeAgent({ tool, message }) {
  const stateGraph = [];

  if (!TOOLS[tool]) {
    return {
      reply: "Tool not found.",
      stateGraph,
      success: false
    };
  }

  const result = await TOOLS[tool].execute(message);

  stateGraph.push({
    step: 1,
    tool,
    input: message,
    output: result,
    final: result?.final ?? true
  });

  // If tool failed
  if (!result?.success) {
    return {
      reply: result?.error || "Tool execution failed.",
      stateGraph,
      success: false
    };
  }

  // ğŸ”¥ Summarize search & finance tools
  if (["search", "finance"].includes(tool)) {
    const summarized = await summarizeWithLLM(message, result);

    stateGraph[0].output.data.text = summarized;

    return {
      reply: summarized,
      stateGraph,
      tool,
      data: result.data,
      success: true
    };
  }

  // Normal tools (llm, calculator, file)
  const reply =
    result?.data?.text ||
    result?.output ||
    JSON.stringify(result?.data) ||
    "Task completed.";

  return {
    reply,
    stateGraph,
    tool,
    data: result.data,
    success: true
  };
}



memory.js:

import fs from "fs";
import path from "path";

export function loadJSON(filePath, defaultValue = {}) {
  try {
    const absolutePath = path.resolve(filePath);

    if (!fs.existsSync(absolutePath)) {
      return defaultValue;
    }

    const raw = fs.readFileSync(absolutePath, "utf-8");
    return JSON.parse(raw);
  } catch (err) {
    console.error("Error loading JSON:", err.message);
    return defaultValue;
  }
}

export function saveJSON(filePath, data) {
  try {
    const absolutePath = path.resolve(filePath);
    fs.writeFileSync(absolutePath, JSON.stringify(data, null, 2));
  } catch (err) {
    console.error("Error saving JSON:", err.message);
  }
}


planner.js:
// server/planner.js

const FILE_REGEX = /[A-Za-z]:[\\/]/;
const PURE_MATH_REGEX = /^[0-9+\-*/().\s]+$/;

const REALTIME_KEYWORDS = [
  "current",
  "today",
  "latest",
  "rate",
  "price",
  "news",
  "weather",
  "exchange"
];

/**
 * Detect stock-related queries like:
 * - AAPL price
 * - what is AAPL stock price?
 * - TSLA share price
 */
function isStockQuery(message) {
  const lower = message.toLowerCase();

  return (
    /\b[A-Z]{1,5}\b/.test(message) &&
    (
      lower.includes("stock") ||
      lower.includes("price") ||
      lower.includes("share")
    )
  );
}

/**
 * Detect if real-time external info is needed
 */
function needsSearch(message) {
  const lower = message.toLowerCase();
  return REALTIME_KEYWORDS.some(word => lower.includes(word));
}

export async function plan({ message }) {
  const trimmed = message.trim();

  // 1ï¸âƒ£ File paths
  if (FILE_REGEX.test(trimmed)) {
    return { tool: "file", reason: "File path detected" };
  }

  // 2ï¸âƒ£ Pure math expressions
  if (PURE_MATH_REGEX.test(trimmed)) {
    return { tool: "calculator", reason: "Math expression detected" };
  }

  // 3ï¸âƒ£ Stock queries
  if (isStockQuery(trimmed)) {
    return { tool: "finance", reason: "Stock query detected" };
  }

  // 4ï¸âƒ£ Real-time info
  if (needsSearch(trimmed)) {
    return { tool: "search", reason: "Real-time info requested" };
  }

  // 5ï¸âƒ£ Default â†’ LLM conversation
  return { tool: "llm", reason: "General conversation" };
}



tools/file.js:
// server/tools/file.js
// File system tool (sandboxed)

import fs from "fs/promises";
import path from "path";

const SANDBOX_ROOT = "E:/sandbox"; // adjust your sandbox path

/**
 * Ensure the given path is inside sandbox
 */
function sanitizePath(requestedPath) {
  const resolved = path.resolve(SANDBOX_ROOT, requestedPath);
  if (!resolved.startsWith(SANDBOX_ROOT)) throw new Error("Access outside sandbox denied");
  return resolved;
}

export async function file(request) {
  try {
    const sanitizedPath = sanitizePath(request);

    const stat = await fs.stat(sanitizedPath);
    let data = {};

    if (stat.isDirectory()) {
      const items = await fs.readdir(sanitizedPath, { withFileTypes: true });
      data.items = items.map(i => ({
        name: i.name,
        type: i.isDirectory() ? "folder" : "file"
      }));
      data.text = `Folder contents:\n${data.items.map(i => `${i.type}: ${i.name}`).join("\n")}`;
    } else if (stat.isFile()) {
      const content = await fs.readFile(sanitizedPath, "utf-8");
      data.items = [{ name: path.basename(sanitizedPath), type: "file", size: stat.size }];
      data.text = `File: ${path.basename(sanitizedPath)} (${stat.size} bytes)\nPreview:\n${content.slice(0, 500)}`;
    } else {
      data.text = "Unknown file type.";
    }

    return {
      tool: "file",
      success: true,
      final: true,
      data
    };
  } catch (err) {
    return {
      tool: "file",
      success: false,
      final: true,
      error: err.message
    };
  }
}

tools/calculator.js:
// server/tools/calculator.js
// Deterministic safe calculator tool
// Structured return system

function sanitizeExpression(input) {
  const match = input.match(/[-+*/().\d\s]+/);
  if (!match) return null;

  const expr = match[0];

  if (!/^[\d+\-*/().\s]+$/.test(expr)) return null;

  return expr;
}

function evaluateExpression(expr) {
  try {
    const result = Function(`"use strict"; return (${expr})`)();

    if (typeof result !== "number" || !isFinite(result)) {
      return { error: "Invalid calculation result" };
    }

    return { result };
  } catch {
    return { error: "Invalid mathematical expression" };
  }
}

export function calculator(message) {
  const expr = sanitizeExpression(message);

  if (!expr) {
    return {
      tool: "calculator",
      success: false,
      final: true,
      error: "No valid math expression found"
    };
  }

  const evaluation = evaluateExpression(expr);

  if (evaluation.error) {
    return {
      tool: "calculator",
      success: false,
      final: true,
      error: evaluation.error
    };
  }

  return {
    tool: "calculator",
    success: true,
    final: true,
    data: {
      expression: expr,
      result: evaluation.result
    }
  };
}


tools/finance.js:
// server/tools/finance.js
import { safeFetch } from "../utils/fetch.js";
import { CONFIG } from "../utils/config.js";

function extractTickers(text) {
  const matches = text.match(/\b[A-Z]{1,5}\b/g);
  return matches || [];
}

async function fetchAlpha(symbol) {
  if (!CONFIG.ALPHA_VANTAGE_KEY) return null;

  const url =
    `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${CONFIG.ALPHA_VANTAGE_KEY}`;

  const data = await safeFetch(url);

  if (!data || !data["Global Quote"]) return null;

  return {
    symbol,
    price: data["Global Quote"]["05. price"],
    change_percent: data["Global Quote"]["10. change percent"]
  };
}

async function fetchFinnhub(symbol) {
  if (!CONFIG.FINNHUB_KEY) return null;

  const url =
    `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${CONFIG.FINNHUB_KEY}`;

  const data = await safeFetch(url);

  if (!data || data.c === undefined) return null;

  return {
    symbol,
    price: data.c,
    change_percent: data.dp + "%"
  };
}

export async function finance(query) {
  if (!CONFIG.isFinanceAvailable()) {
    return {
      tool: "finance",
      success: false,
      final: true,
      error: "No finance API keys configured"
    };
  }

  try {
    const tickers = extractTickers(query);

    if (!tickers.length) {
      return {
        tool: "finance",
        success: false,
        final: true,
        error: "No stock ticker found"
      };
    }

    const results = [];

    for (const symbol of tickers) {
      let data = null;

      if (CONFIG.FINANCE_PROVIDER === "alpha") {
        data = await fetchAlpha(symbol);
        if (!data) data = await fetchFinnhub(symbol);
      } else {
        data = await fetchFinnhub(symbol);
        if (!data) data = await fetchAlpha(symbol);
      }

      if (data) results.push(data);
    }

    if (!results.length) {
      return {
        tool: "finance",
        success: false,
        final: true,
        error: "Failed to fetch stock data"
      };
    }

    const summary = results
      .map(r => `${r.symbol}: $${r.price} (${r.change_percent})`)
      .join("\n");

    return {
      tool: "finance",
      success: true,
      final: true,
      data: {
        stocks: results,
        text: `Stock information:\n${summary}`
      }
    };

  } catch (err) {
    return {
      tool: "finance",
      success: false,
      final: true,
      error: err.message
    };
  }
}


tools/index.js:
// server/tools/index.js

import { calculator } from "./calculator.js";
import { file } from "./file.js";
import { finance } from "./finance.js";
import { search } from "./search.js";
import { llm } from "./llm.js";
import { weather } from "./weather.js";

export const TOOLS = {
  calculator,
  file,
  finance,
  search,
  llm,
  weather
};

tools/llm.js:

// server/tools/llm.js

import fetch from "node-fetch";

export async function llm(input) {
  try {
    const res = await fetch("http://localhost:11434/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "mat-llm:latest",
        prompt: input,
        stream: false
      })
    });

    const data = await res.json();

    const text = data.response?.trim();

    if (!text) {
      return {
        success: false,
        error: "LLM returned empty response",
        final: true
      };
    }

    return {
      success: true,
      data: { text },
      final: true,
      output: text
    };

  } catch (err) {
    return {
      success: false,
      error: "LLM execution failed",
      final: true
    };
  }
}


tools/search.js:

// server/tools/search.js
import { safeFetch } from "../utils/fetch.js";
import { CONFIG } from "../utils/config.js";
import { loadJSON, saveJSON } from "../memory.js";

const CACHE_FILE = "./search_cache.json";

function extractTopic(text) {
  return text.toLowerCase().replace(/[^a-z0-9\s]/g, "").trim();
}

async function fetchWikipedia(query) {
  const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;
  const data = await safeFetch(url);
  if (data?.extract) {
    return [{
      title: data.title,
      snippet: data.extract,
      url: `https://en.wikipedia.org/wiki/${data.title}`
    }];
  }
  return [];
}

async function fetchDuckDuckGo(query) {
  const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`;
  const data = await safeFetch(url);

  if (!data?.RelatedTopics) return [];

  return data.RelatedTopics.slice(0, 5)
    .filter(r => r.Text && r.FirstURL)
    .map(r => ({
      title: r.Text,
      snippet: r.Text,
      url: r.FirstURL
    }));
}

async function fetchGoogle(query) {
  if (!CONFIG.SERPAPI_KEY) return [];

  const url = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&api_key=${CONFIG.SERPAPI_KEY}`;
  const data = await safeFetch(url);

  if (!data?.organic_results) return [];

  return data.organic_results.slice(0, 5).map(r => ({
    title: r.title,
    snippet: r.snippet || "",
    url: r.link
  }));
}

export async function search(query) {
  const cache = loadJSON(CACHE_FILE, {});
  const topic = extractTopic(query);

  if (cache[topic]) {
    return {
      tool: "search",
      success: true,
      final: true,
      data: cache[topic]
    };
  }

  const [wiki, ddg, google] = await Promise.all([
    fetchWikipedia(query),
    fetchDuckDuckGo(query),
    fetchGoogle(query)
  ]);

  const results = [...wiki, ...ddg, ...google];

  const summary = results.map(r => `${r.title}: ${r.snippet}`).join("\n");

  const data = { results, text: summary };

  cache[topic] = data;
  saveJSON(CACHE_FILE, cache);

  return {
    tool: "search",
    success: true,
    final: true,
    data
  };
}

tools/weather.js:

import { safeFetch } from "../utils/fetch.js";

export async function weather(query) {
  try {
    const cityMatch = query.match(/in\s+([A-Za-z\s]+)/i);
    const city = cityMatch ? cityMatch[1].trim() : "London";

    const geo = await safeFetch(
      `https://geocoding-api.open-meteo.com/v1/search?name=${city}`
    );

    if (!geo.results?.length) {
      return {
        tool: "weather",
        success: false,
        final: true,
        error: "City not found"
      };
    }

    const { latitude, longitude } = geo.results[0];

    const weatherData = await safeFetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`
    );

    return {
      tool: "weather",
      success: true,
      final: true,
      data: {
        text: `Current temperature in ${city}: ${weatherData.current_weather.temperature}Â°C`
      }
    };

  } catch (err) {
    return {
      tool: "weather",
      success: false,
      final: true,
      error: err.message
    };
  }
}


util/config.js:
// server/utils/config.js
import 'dotenv/config';

/**
 * Centralized configuration with validation
 */

const warnings = [];

// Validate finance providers
if (!process.env.ALPHA_VANTAGE_KEY && !process.env.FINNHUB_KEY) {
  warnings.push("âš ï¸  No finance API keys set - finance tool will be unavailable");
}

// Validate search
if (!process.env.SERPAPI_KEY) {
  warnings.push("âš ï¸  SERPAPI_KEY not set - search features may be limited");
}

export const CONFIG = {
  // Server
  PORT: process.env.PORT || 3000,
  NODE_ENV: process.env.NODE_ENV || 'development',

  // LLM
  LLM_MODEL: process.env.LLM_MODEL || 'llama3.2',
  LLM_API_URL: process.env.LLM_API_URL || 'http://localhost:11434',

  // Agent Limits
  MAX_STEPS: parseInt(process.env.MAX_STEPS || '3'),
  TOOL_BUDGET_SEARCH: parseInt(process.env.TOOL_BUDGET_SEARCH || '3'),
  TOOL_BUDGET_FINANCE: parseInt(process.env.TOOL_BUDGET_FINANCE || '2'),
  TOOL_BUDGET_CALCULATOR: parseInt(process.env.TOOL_BUDGET_CALCULATOR || '1'),

  // Finance Providers
  FINANCE_PROVIDER: process.env.FINANCE_PROVIDER || 'alpha', // alpha | finnhub

  ALPHA_VANTAGE_KEY: process.env.ALPHA_VANTAGE_KEY,
  FINNHUB_KEY: process.env.FINNHUB_KEY,

  // Search
  SERPAPI_KEY: process.env.SERPAPI_KEY,

  // Critical Tools
  CRITICAL_TOOLS: (process.env.CRITICAL_TOOLS || 'finance').split(','),

  // Cache
  SEARCH_CACHE_TTL: parseInt(process.env.SEARCH_CACHE_TTL || '3600000'),

  isFinanceAvailable() {
    return !!(this.ALPHA_VANTAGE_KEY || this.FINNHUB_KEY);
  },

  getWarnings() {
    return warnings;
  }
};

// Log warnings
if (warnings.length > 0) {
  console.warn('\n' + '='.repeat(60));
  console.warn('âš ï¸  CONFIGURATION WARNINGS:');
  warnings.forEach(w => console.warn(w));
  console.warn('='.repeat(60) + '\n');
}

if (!process.env.LLM_MODEL) {
  console.info(`â„¹ï¸  Using default LLM model: ${CONFIG.LLM_MODEL}`);
  console.log("Alpha Vantage Key:", CONFIG.ALPHA_VANTAGE_KEY);
  console.log("Finnhub Key:", CONFIG.FINNHUB_KEY);
  console.log("Finance Provider:", CONFIG.FINANCE_PROVIDER);
}


util/ fetch.js:

import fetch from "node-fetch";

export async function safeFetch(url, options = {}) {
  try {
    const res = await fetch(url, options);

    if (!res.ok) {
      console.error(`Fetch error: HTTP ${res.status}`);
      return null;
    }

    const contentType = res.headers.get("content-type") || "";

    if (contentType.includes("application/json")) {
      return await res.json();
    }

    const text = await res.text();

    try {
      return JSON.parse(text);
    } catch {
      return null;
    }
  } catch (err) {
    console.error("Fetch error:", err.message);
    return null;
  }
}

local-llm-ui/
â”‚
â”œâ”€â”€ client/
â”‚   â””â”€â”€ local-llm-ui/
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ App.jsx
â”‚           â””â”€â”€ App.css
â”‚
â””â”€â”€ server/
    â”œâ”€â”€ index.js
    â”œâ”€â”€ executor.js
    â”œâ”€â”€ planner.js
    â”œâ”€â”€ memory.js
    â”œâ”€â”€ audit.js
    â”‚
    â”œâ”€â”€ tools/
    â”‚   â”œâ”€â”€ calculator.js
    â”‚   â”œâ”€â”€ file.js
    â”‚   â”œâ”€â”€ finance.js
    â”‚   â”œâ”€â”€ search.js
    â”‚   â”œâ”€â”€ llm.js
    |   â”œâ”€â”€ weather.js
    â”‚   â””â”€â”€ index.js
    â”‚
    â””â”€â”€ utils/
        â”œâ”€â”€ fetch.js
        â””â”€â”€ config.js


        