// server/tools/selfImprovement.js
import { getRecentImprovements, generateSummaryReport } from "../telemetryAudit.js";
import { getIntentAccuracyReport, detectMisroutingPatterns, getRoutingRecommendations } from "../intentDebugger.js";

/**
 * Self-improvement tool
 * Handles queries about agent's self-modifications and improvements
 */
export async function selfImprovement(query) {
  const lower = query.toLowerCase();

  try {
    // Query: "what have you improved lately?"
    if (lower.includes("what have you improved") || lower.includes("what improvements") || lower.includes("show improvements") || lower.includes("list improvements") || lower.includes("recent improvements")) {
      const improvements = await getRecentImprovements(20);

      if (improvements.length === 0) {
        return {
          tool: "selfImprovement",
          success: true,
          final: true,
          data: {
            text: "I haven't recorded any self-improvements yet. I log improvements when I:\n- Modify my own code\n- Install new packages\n- Download learning resources\n- Update configuration files",
            message: "I haven't recorded any self-improvements yet."
          }
        };
      }

      // Group by category
      const byCategory = {};
      for (const imp of improvements) {
        const cat = imp.category || "other";
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(imp);
      }

      // FIX: text must be declared BEFORE the html template literal that references it
      const text = improvements
        .slice(0, 10)
        .map(imp => `\u2022 ${imp.category}: ${imp.action}${imp.reason ? ` (${imp.reason})` : ''}`)
        .join('\n');

      // Build HTML report ‚Äî backtick closed with ` after </style>
      const html = `
        <div class="improvements-report">
          <h2>üîß Recent Self-Improvements</h2>
          ${Object.entries(byCategory).map(([category, items]) => `
            <div class="improvement-category">
              <h3>${category.charAt(0).toUpperCase() + category.slice(1)}</h3>
              <ul class="improvement-list">
                ${items.map(imp => `
                  <li class="improvement-item">
                    <div class="improvement-action">${imp.action}</div>
                    ${imp.reason ? `<div class="improvement-reason">${imp.reason}</div>` : ''}
                    ${imp.file ? `<div class="improvement-file">üìÑ ${imp.file}</div>` : ''}
                    <div class="improvement-timestamp">${new Date(imp.timestamp).toLocaleString()}</div>
                  </li>
                `).join('')}
              </ul>
            </div>
          `).join('')}
          <div class="improvement-summary">
            <p><strong>Total improvements:</strong> ${improvements.length}</p>
            <p><strong>Categories:</strong> ${Object.keys(byCategory).join(', ')}</p>
          </div>
        </div>
        <style>
          .improvements-report { font-family: sans-serif; }
          .improvement-category { margin-bottom: 1rem; }
          .improvement-item { margin-bottom: 0.5rem; }
          .improvement-action { font-weight: bold; }
          .improvement-reason { color: #666; font-size: 0.9em; }
          .improvement-file { color: #888; font-size: 0.85em; }
          .improvement-timestamp { color: #aaa; font-size: 0.8em; }
          .improvement-summary { border-top: 1px solid #eee; padding-top: 0.5rem; margin-top: 1rem; }
        </style>
      `;

      return {
        tool: "selfImprovement",
        success: true,
        final: true,
        data: {
          html,
          text: `Recent improvements:\n\n${text}\n\n(Showing ${Math.min(10, improvements.length)} of ${improvements.length} total)`,
          improvements
        }
      };
    }

    // Query: "how accurate is your routing?"
    if (lower.includes("routing accuracy") || lower.includes("intent accuracy") || lower.includes("how accurate")) {
      const report = await getIntentAccuracyReport();

      // FIX: backtick closed with ` after </style>
      const html = `
        <div class="accuracy-report">
          <h2>üéØ Routing Accuracy Report</h2>
          <div class="accuracy-stats">
            <div class="stat-box">
              <div class="stat-value">${report.successRate.toFixed(1)}%</div>
              <div class="stat-label">Overall Success Rate</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${report.totalDecisions}</div>
              <div class="stat-label">Total Routing Decisions</div>
            </div>
            <div class="stat-box">
              <div class="stat-value">${report.lowConfidenceDecisions.length}</div>
              <div class="stat-label">Low Confidence</div>
            </div>
          </div>
          <h3>By Tool</h3>
          <table class="accuracy-table">
            <thead>
              <tr>
                <th>Tool</th><th>Total</th><th>Successes</th>
                <th>Success Rate</th><th>Avg Confidence</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(report.byTool)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([tool, stats]) => `
                  <tr>
                    <td>${tool}</td>
                    <td>${stats.total}</td>
                    <td>${stats.successes}</td>
                    <td>${((stats.successes / stats.total) * 100).toFixed(1)}%</td>
                    <td>${stats.averageConfidence ? stats.averageConfidence.toFixed(2) : 'N/A'}</td>
                  </tr>
                `).join('')}
            </tbody>
          </table>
        </div>
        <style>
          .accuracy-report { font-family: sans-serif; }
          .accuracy-stats { display: flex; gap: 1rem; margin-bottom: 1rem; }
          .stat-box { background: #f5f5f5; border-radius: 8px; padding: 1rem; text-align: center; }
          .stat-value { font-size: 2rem; font-weight: bold; }
          .stat-label { color: #666; font-size: 0.85em; }
          .accuracy-table { width: 100%; border-collapse: collapse; }
          .accuracy-table th, .accuracy-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          .accuracy-table th { background: #f0f0f0; }
        </style>
      `;

      return {
        tool: "selfImprovement",
        success: true,
        final: true,
        data: { html, report }
      };
    }

    // Query: "what issues have you detected?"
    if (lower.includes("detected issues") || lower.includes("what problems") || lower.includes("misrouting patterns")) {
      const patterns = await detectMisroutingPatterns();
      const recommendations = await getRoutingRecommendations();

      if (patterns.length === 0 && recommendations.length === 0) {
        return {
          tool: "selfImprovement",
          success: true,
          final: true,
          data: { text: "‚úÖ No significant issues detected! Routing performance looks good." }
        };
      }

      // FIX: backtick closed with ` after </style>
      const html = `
        <div class="issues-report">
          <h2>‚ö†Ô∏è Detected Issues & Recommendations</h2>
          ${patterns.length > 0 ? `
            <h3>Patterns Detected</h3>
            <ul class="issues-list">
              ${patterns.map(p => `
                <li class="issue-item">
                  <div class="issue-type">${p.type.replace(/_/g, ' ').toUpperCase()}</div>
                  <div class="issue-recommendation">${p.recommendation}</div>
                </li>
              `).join('')}
            </ul>
          ` : ''}
          ${recommendations.length > 0 ? `
            <h3>Recommendations</h3>
            <ul class="recommendations-list">
              ${recommendations.map(r => `
                <li class="recommendation-item priority-${r.priority}">
                  <div class="recommendation-header">
                    <span class="recommendation-priority">${r.priority.toUpperCase()}</span>
                    <span class="recommendation-category">${r.category}</span>
                  </div>
                  <div class="recommendation-details">${r.details}</div>
                </li>
              `).join('')}
            </ul>
          ` : ''}
        </div>
        <style>
          .issues-report { font-family: sans-serif; }
          .issue-item { margin-bottom: 0.75rem; padding: 0.5rem; background: #fff8e1; border-radius: 4px; }
          .issue-type { font-weight: bold; color: #e65100; }
          .issue-recommendation { color: #555; margin-top: 0.25rem; }
          .recommendation-item { margin-bottom: 0.75rem; padding: 0.5rem; border-radius: 4px; border-left: 4px solid #2196f3; }
          .recommendation-item.priority-high { border-left-color: #f44336; }
          .recommendation-item.priority-medium { border-left-color: #ff9800; }
          .recommendation-item.priority-low { border-left-color: #4caf50; }
          .recommendation-header { display: flex; gap: 0.5rem; margin-bottom: 0.25rem; }
          .recommendation-priority { font-weight: bold; text-transform: uppercase; font-size: 0.8em; }
          .recommendation-category { color: #666; font-size: 0.85em; }
          .recommendation-details { color: #444; }
        </style>
      `;

      return {
        tool: "selfImprovement",
        success: true,
        final: true,
        data: { html, patterns, recommendations }
      };
    }

    // Query: "Review your own logic" or "Suggest improvements to yourself"
    if (lower.includes("review your") || lower.includes("suggest improvement") || (lower.includes("make you") && (lower.includes("smarter") || lower.includes("faster")))) {
      const { review } = await import("./review.js");

      const target = lower.includes("planner") ? "server/planner.js" :
        lower.includes("executor") ? "server/executor.js" :
          "server/planner.js";

      const reviewResult = await review(`review ${target}`);

      if (reviewResult.success) {
        const message = `ü§ñ **Self-Critique (${target}):**\n\nI've analyzed my core logic in \`${target}\`. Here are some ways I can improve:\n\n${reviewResult.data.reviewText}`;
        return {
          tool: "selfImprovement",
          success: true,
          final: true,
          data: {
            ...reviewResult.data,
            text: message,
            html: reviewResult.data.html || message,
            message
          }
        };
      }
    }

    // Query: "generate weekly report"
    if (lower.includes("weekly report") || lower.includes("generate report") || lower.includes("summary report")) {
      const htmlReport = await generateSummaryReport();

      return {
        tool: "selfImprovement",
        success: true,
        final: true,
        data: {
          html: htmlReport,
          text: "Weekly report generated. This can be sent via email.",
          report: htmlReport
        }
      };
    }

    // Default: unknown query
    return {
      tool: "selfImprovement",
      success: false,
      final: true,
      error: "I can help with:\n- 'what have you improved lately?'\n- 'how accurate is your routing?'\n- 'what issues have you detected?'\n- 'Review your own logic (planner/executor)'\n- 'suggest improvements to make you smarter'"
    };

  } catch (err) {
    return {
      tool: "selfImprovement",
      success: false,
      final: true,
      error: `Self-improvement query failed: ${err.message}`
    };
  }
}
